---
title: "Case-Shiller 3-Tier City Index Assessment"
output: pdf_document
---


```{r}
# load necessary library
library(forecast) # for prediction
library(dygraphs) # for visulization

# load all csv file into dataframe
temp = list.files(pattern="*.csv")
for (i in 1:length(temp)) {
  assign(strtrim(temp[i], (nchar(temp[i]) - 4)), read.csv(temp[i]))
}

# convert Boston Home Index data (3 tiers) into time series object
boxrhtnsats <- ts(BOXRHTNSA[,2], start = c(1987, 1), frequency = 12)
boxrltnsats <- ts(BOXRLTNSA[,2], start = c(1987, 1), frequency = 12)
boxrmtnsats <- ts(BOXRMTNSA[,2], start = c(1987, 1), frequency = 12)

# the cross-validation implied here is a rolling basis
# for example, the first training group is year 1 and test group is year 2
# then, the second training group is year 1 and 2 and test group is year 3
# the training group keeps rolling up each iteration and test group is always the next 12 months
# maybe except for the last year
# whatever left in the last year (< 12 months) will be added to the previous year as a test group

# to obtain the number of trainning groups and the number of months in the last test group
numy.bos = floor(length(boxrhtnsats) / 12) - 1
extra.bos = length(boxrhtnsats) - numy.bos * 12

# for high tier Index
# to create one numeric vector for storing mae value and one list for ARIMA parameters
models.bosht <- vector("list", numy.bos)
maes.bosht <- vector("numeric", numy.bos)

# loop through every year(except for only the frist year as a training set 
# since the seasonal factor will fail on this set)
for (i in 2:numy.bos){
  
  # use auto.arima to find a best model on training set
  boxrhtnsafc <- auto.arima(window(boxrhtnsats, 1987, c(1986 + i, 12)), D = 1)
  
  # store arima parameter
  models.bosht[[i]] <- boxrhtnsafc$arma
  
  # decide if the test group is the last year plus extra months
  if (i == numy.bos){
    pred <- forecast(boxrhtnsafc, extra.bos)

    # if the test group is the last year then test if it is a whole year
    if (extra.bos == 12){
      maes.bosht[i] <- mean(abs(pred$mean - window(boxrhtnsats, (1986 + i + 1), c(1986 + i + 1, 12))))
    } else {
      # if not a whole year then the extra months are added to the previous group
      maes.bosht[i] <- mean(abs(pred$mean - window(boxrhtnsats, (1986 + i + 1), c(1986 + i + 2, extra.bos - 12))))
    }
    
  # if the test group is not the last year then just predict the next 12 months
  } else {
    pred <- forecast(boxrhtnsafc, 12)
    maes.bosht[i] <- mean(abs(pred$mean - window(boxrhtnsats, (1986 + i + 1), c(1986 + i + 1, 12))))
  }
}
# the rolling basis cross-validation method may be improved in the future

# using mae criterion for the best fitting model
para.bosht <- models.bosht[[which.min(maes.bosht[2:numy.bos]) + 1]]

# fit the optimal model to the whole data set
# and predict for the next whole year
boxrhtnsafc <- arima(boxrhtnsats, order = c(para.bosht[1], para.bosht[6], para.bosht[2]), seasonal = list(order = c(para.bosht[3], para.bosht[7], para.bosht[4]), period = para.bosht[5]))
prediction.bosht <- forecast(boxrhtnsafc, (24 - extra.bos))
pred.bosht <- prediction.bosht$mean

# repeat the modelling process on other two tiers

# for low tier
models.boslt <- vector("list", numy.bos)
maes.boslt <- vector("numeric", numy.bos)
for (i in 2:numy.bos){
  boxrltnsafc <- auto.arima(window(boxrltnsats, 1987, c(1986 + i, 12)), D = 1)
  models.boslt[[i]] <- boxrltnsafc$arma
  if (i == numy.bos){
    pred <- forecast(boxrltnsafc, extra.bos)
    if (extra.bos == 12){
      maes.boslt[i] <- mean(abs(pred$mean - window(boxrltnsats, (1986 + i + 1), c(1986 + i + 1, 12))))
    } else {
      maes.boslt[i] <- mean(abs(pred$mean - window(boxrltnsats, (1986 + i + 1), c(1986 + i + 2, extra.bos - 12))))
    }
  } else {
    pred <- forecast(boxrltnsafc, 12)
    maes.boslt[i] <- mean(abs(pred$mean - window(boxrltnsats, (1986 + i + 1), c(1986 + i + 1, 12))))
  }
}
para.boslt <- models.boslt[[which.min(maes.boslt[2:numy.bos]) + 1]]
boxrltnsafc <- arima(boxrltnsats, order = c(para.boslt[1], para.boslt[6], para.boslt[2]), seasonal = list(order = c(para.boslt[3], para.boslt[7], para.boslt[4]), period = para.boslt[5]))
prediction.boslt <- forecast(boxrltnsafc, (24 - extra.bos))
pred.boslt <- prediction.boslt$mean

# for middle tier
models.bosmt <- vector("list", numy.bos)
maes.bosmt <- vector("numeric", numy.bos)
for (i in 2:numy.bos){
  boxrmtnsafc <- auto.arima(window(boxrmtnsats, 1987, c(1986 + i, 12)), D = 1)
  models.bosmt[[i]] <- boxrmtnsafc$arma
  if (i == numy.bos){
    pred <- forecast(boxrmtnsafc, extra.bos)
    if (extra.bos == 12){
      maes.bosmt[i] <- mean(abs(pred$mean - window(boxrmtnsats, (1986 + i + 1), c(1986 + i + 1, 12))))
    } else {
      maes.bosmt[i] <- mean(abs(pred$mean - window(boxrmtnsats, (1986 + i + 1), c(1986 + i + 2, extra.bos - 12))))
    }
  } else {
    pred <- forecast(boxrmtnsafc, 12)
    maes.bosmt[i] <- mean(abs(pred$mean - window(boxrmtnsats, (1986 + i + 1), c(1986 + i + 1, 12))))
  }
}
para.bosmt <- models.bosmt[[which.min(maes.bosmt[2:numy.bos]) + 1]]
boxrmtnsafc <- arima(boxrmtnsats, order = c(para.bosmt[1], para.bosmt[6], para.bosmt[2]), seasonal = list(order = c(para.bosmt[3], para.bosmt[7], para.bosmt[4]), period = para.bosmt[5]))
prediction.bosmt <- forecast(boxrmtnsafc, (24 - extra.bos))
pred.bosmt <- prediction.bosmt$mean

# combine the original data and the prediction into one data frame 
boxrnsa <- cbind(boxrhtnsats, boxrmtnsats, boxrltnsats, pred.bosht, pred.bosmt, pred.boslt)


```

